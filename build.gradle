/*
 * This file was generated by the Gradle 'init' task.
 *
 * This generated file contains a sample Java Library project to get you started.
 * For more details take a look at the Java Libraries chapter in the Gradle
 * User Manual available at https://docs.gradle.org/5.4.1/userguide/java_library_plugin.html
 */

plugins {
    id 'scala'
}

repositories {
    jcenter()
}


configurations {
    gatlingtest
}


sourceSets {
    scripts {
        scala {
            srcDirs = ['gatling/scripts']
        }
        resources {
            srcDirs = ['gatling/resources']
        }
        compileClasspath += configurations.gatlingtest
        runtimeClasspath += configurations.gatlingtest

    }
}

dependencies {
    gatlingtest 'org.scala-lang:scala-library:2.12.0'
    gatlingtest 'io.gatling.highcharts:gatling-charts-highcharts:3.0.0'
}

task renameReportDir {
    doLast {
        // find the directory
        def report = {file -> file.isDirectory() && (file.getName().startsWith('executepostgetscenarios'))}
        def reportDirectory = new File("${buildDir}/reports/gatling").listFiles().toList()
                .findAll(report)
                .sort()
                .last()
        // rename to a known directory
        reportDirectory.renameTo("${buildDir}/reports/gatling/gatlingscenarios")
    }
}

task runGatlingGetScript(type: JavaExec) {
    description = 'Run gatling tests'
    new File("${buildDir}/reports/gatling").mkdirs()
    classpath = sourceSets.scripts.runtimeClasspath + configurations.gatlingtest
    main = "io.gatling.app.Gatling"
    args = ['-s', 'brainstorming.GetUsersScenario',
            '-sf', 'gatling/resources',
            '-df', 'gatling/resources',
            '-rf', "${buildDir}/reports/gatling"
    ]
}

task runGatlingPostScript(type: JavaExec) {
    description = 'Run gatling tests'
    new File("${buildDir}/reports/gatling").mkdirs()
    classpath = sourceSets.scripts.runtimeClasspath + configurations.gatlingtest
    main = "io.gatling.app.Gatling"
    args = ['-s', 'brainstorming.PostUserScenarios',
            '-sf', 'gatling/resources',
            '-df', 'gatling/resources',
            '-rf', "${buildDir}/reports/gatling"
    ]
}

task runGetPostScript(type: JavaExec) {
    description = 'Run gatling tests'
    new File("${buildDir}/reports/gatling").mkdirs()
    classpath = sourceSets.scripts.runtimeClasspath + configurations.gatlingtest
    main = "io.gatling.app.Gatling"
    args = ['-s', 'brainstorming.ExecutePostGetScenarios',
            '-sf', 'gatling/resources',
            '-df', 'gatling/resources',
            '-rf', "${buildDir}/reports/gatling"
    ]
}

runGetPostScript.finalizedBy renameReportDir

// it is run after test phase
test.finalizedBy renameReportDir

runGatlingPostScript.finalizedBy renameReportDir
runGatlingGetScript.finalizedBy renameReportDir

test.dependsOn runGatlingGetScript

task printClasspath {
    doLast {
        def classpath = sourceSets.scripts.runtimeClasspath + configurations.gatlingtests
        classpath.each { println it }
    }
}

task showConfigurations  {
    doLast {
        configurations.all { conf -> println(conf) }
    }
}